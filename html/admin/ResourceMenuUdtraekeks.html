<!DOCTYPE html>
<html lang="en">
  <head id="head">
  </head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div id="menu" class="sidebar border border-right col-md-3 col-lg-2 p-2 bg-body-tertiary"></div>
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div id="roomMenu"></div>

                    <div class="row p-2">
                <div class="flex-shrink-0 p-3" style="width: 280px;">
                  <ul class="list-unstyled ps-0">
                    <li class="mb-1" id="folders">
                    </li>
                  </ul>
                </div>
              <div class="col-md-6">
                <h3>Resourcer</h3>
                <div id="resource">
                  <p>Vælg et menupunkt her til højre</p>
              
                </div>
              </div>
            </div>
    </main>
    </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
            <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", async ()  => {
    $(function() {
          $("#menu").load("http://localhost:5500/html/includes/menu.html");
       });
       $(function() {
          $("#head").load("http://localhost:5500/html/includes/head.html");
       });
       $(function() {
          $("#roomMenu").load("http://localhost:5500/html/includes/roomMenu.html");
       });
       var room_id = JSON.parse(localStorage.getItem("selected_room")).room_id;

const rootFolders = await getRoomFolders(room_id);
const nestedFolders = [];

for (const rootFolder of rootFolders) {
const folderId = rootFolder.folder_id;
const folderName = rootFolder.folder_name;

const rootFolderWithSubfolders = {
id: folderId,
name: folderName,
subfolders: [],
};

const subFolders = await getSubFolders(folderId, room_id);
for (const subfolder of subFolders) {
const subfolderId = subfolder.folder_id;
const subfolderName = subfolder.folder_name;

const subsubfolders = await getSubFolders(subfolderId, room_id);
let subsubfolderId = '';
let subsubfolderName = '';
for (const subsubfolder of subsubfolders){
  subsubfolderId = subsubfolder.folder_id;
  subsubfolderName = subsubfolder.folder_name;

}

const subfoldersObject = {
  id: subfolderId,
  name: subfolderName,
  subfolders: [],
};

if (subsubfolders) {
  subfoldersObject.subfolders = subsubfolders;
}

rootFolderWithSubfolders.subfolders.push(subfoldersObject);
}

nestedFolders.push(rootFolderWithSubfolders);

}

const foldersElement = document.getElementById('folders');

for (const rootFolder of nestedFolders){
  console.log(rootFolder);
  const rootFolderButton = document.createElement("button");
  rootFolderButton.classList = "btn btn-toggle d-inline-flex align-items-center rounded border-0";
  rootFolderButton.setAttribute("data-bs-toggle", "collapse");
  rootFolderButton.setAttribute("data-bs-target", "#" + rootFolder.name);
  rootFolderButton.setAttribute("aria-expanded", false);
  rootFolderButton.innerHTML = `<i class="bi bi-folder p-2"></i> ${rootFolder.name}`;

  const rootFolderDiv = document.createElement('div');
  rootFolderDiv.setAttribute("id", rootFolder.name);
  rootFolderDiv.classList.add('collapse');
  
  const rootFolderul = document.createElement('ul');
  rootFolderul.classList = "btn-toggle-nav list-unstyled fw-normal pb-1 small";



  const subFolders = rootFolder.subfolders;
  for (const subFolder of subFolders){
    const subsubFolders = subFolder.subfolders;
    console.log(subsubFolders)
    if (subsubFolders.length == 0){
      const subfolderwithoutsubfolderli = document.createElement('li');
      const subfolderwithoutsubfoldera = document.createElement('a');
      subfolderwithoutsubfoldera.classList = "link-dark d-inline-flex text-decoration-none rounded align-items-center subFolder";
      subfolderwithoutsubfoldera.href = "#";
      subfolderwithoutsubfoldera.innerHTML = `${subFolder.name}`
      subfolderwithoutsubfoldera.addEventListener('click', (event) => {
    if (event.type === 'click') {
      updatePage();
    }
  });
      subfolderwithoutsubfolderli.appendChild(subfolderwithoutsubfoldera);
      rootFolderul.appendChild(subfolderwithoutsubfolderli);

    }else{
      const subsubfolderli = document.createElement('li');
      const subsubfolderul = document.createElement('ul');
      subsubfolderul.classList.add('subFolder');

      const subsubButton = document.createElement("button");
      subsubButton.classList = "btn-toggle d-inline-flex align-items-center rounded border-0";
      subsubButton.setAttribute("data-bs-toggle", "collapse");
      subsubButton.setAttribute("data-bs-target", "#" + subFolder.name+subFolder.id);
      subsubButton.setAttribute("aria-expanded", false);
      subsubButton.innerHTML = `<i class="bi bi-folder p-2"></i> ${subFolder.name}`;

      subsubfolderul.appendChild(subsubButton);
      subsubfolderli.appendChild(subsubfolderul);
  const subsubDiv = document.createElement('div');
  subsubDiv.setAttribute("id", subFolder.name+subFolder.id);
  subsubDiv.classList.add('collapse');
  
  const subsubul = document.createElement('ul');
  subsubul.classList = "btn-toggle-nav list-unstyled fw-normal pb-1 small";

subsubFolders.forEach(element => {
  const subsubli = document.createElement('li');
  const subsuba = document.createElement('a');
      subsuba.classList = "link-dark d-inline-flex text-decoration-none rounded align-items-center";
      subsuba.href = "#";
      subsuba.innerHTML = `${element.folder_name}`
      subsubli.appendChild(subsuba);
      subsubul.appendChild(subsubli);
      subsubDiv.appendChild(subsubul);
});


  subsubfolderul.appendChild(subsubDiv);
  rootFolderDiv.appendChild(subsubfolderul);
    }
  }

  rootFolderDiv.appendChild(rootFolderul);


foldersElement.appendChild(rootFolderButton);
foldersElement.appendChild(rootFolderDiv);


}

});
  async function getRoomFolders(room_id){
    try {
          const response = await fetch("http://49.13.148.231:3000/rpc/get_folder_by_room_oid?room_oid=" + room_id, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicG9zdGdyZXMifQ.thixYwIHRZruXR7QWz6suUrzy81LsXdQsms3BU6cdFg'
          // Add any additional headers if needed
        },
        // Add any function parameters as needed
      });
  
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
  
      const result = await response.json();
      return result;
    } catch (error) {
      console.error('Error calling PostgREST function:', error.message);
    }
  }
  async function getSubFolders(folder_id, room_id) {
  const formData = {
    over_folder_id: folder_id,
    room_oid: room_id,
    // Add other form data as needed
  };
  const requestBody = {
    folder_info: formData,
  };
  var myHeaders = new Headers();
myHeaders.append("Content-Type", "application/json");
myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicG9zdGdyZXMifQ.thixYwIHRZruXR7QWz6suUrzy81LsXdQsms3BU6cdFg");
  var requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: JSON.stringify(requestBody),
    redirect: 'follow'
  };

  return fetch("http://49.13.148.231:3000/rpc/get_folders_under_folder", requestOptions)
    .then(response => response.json())
    .then(result => result)
    .catch(error => console.log('error', error));
}
async function updatePage() {
  try {
          const response = await fetch("http://49.13.148.231:3000/rpc/get_all_users_events?user_name=" + JSON.parse(localStorage.getItem("logged_in_user")).email, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicG9zdGdyZXMifQ.thixYwIHRZruXR7QWz6suUrzy81LsXdQsms3BU6cdFg'
          // Add any additional headers if needed
        },
        // Add any function parameters as needed
      });
  
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
  
      const result = await response.json();
      const element =document.getElementById("resource");
          element.innerHTML = "";
      result.forEach(event => {
        if (event.events_resource_id == 2){

          console.log(event);
          element.innerHTML += `${event.events_title}<br>`;
        }
      });
    } catch (error) {
      console.error('Error calling PostgREST function:', error.message);
    }
}

            
            </script>
</body>
</html>